# Senim Workout Service

## Описание

Микросервис для отслеживания и учёта повторений упражнений в реальном времени с помощью WebSocket и хранения результатов в базе данных PostgreSQL. Использует FastAPI, Redis для асинхронной работы с БД через SQLAlchemy.

## Основные возможности

- Подключение по WebSocket для получения событий о повторениях (`rep_detected`)
- Дебаунс с использованием Redis
- Сохранение итоговых результатов тренировки в PostgreSQL
- REST API для завершения тренировки и получения ID сохранённой сессии

## Технологии

- Python 3.11
- FastAPI
- Redis (asyncio)
- PostgreSQL
- SQLAlchemy (async)
- Alembic (миграции)
- Docker, Docker Compose

## Быстрый старт

1. **Клонируйте репозиторий:**
   ```sh
   git clone <repo-url>
   cd senim-workout-service
   ```

2. **Создайте файл `.env` (Для удобства предоставлены дефолтные значения):**
   ```
   REDIS_URL=redis://redis:6379/0
   DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/senim
   ```

3. **Запустите сервисы через Docker Compose:**
   ```sh
   docker compose up --build
   ```

4. **Миграции БД выполняются автоматически при запуске.**

## Основные эндпоинты

- `GET /` — Проверка работоспособности сервиса
- `POST /workout/finish` — Завершение тренировки, сохранение результата
- `GET /workout/sessions` — Получение списка всех сохранённых тренировочных сессий
- `WS /ws/workout` — WebSocket для отправки событий о повторениях

## Пример работы WebSocket

1. Подключитесь к `ws://localhost:8000/ws/workout`
2. Отправляйте сообщения:
   ```json
   {"event": "rep_detected", "type": "squat"}
   ```
3. Получайте ответы с текущим количеством повторений.

### Тестирование WebSocket через консоль

#### Linux и macOS

Установите [websocat](https://github.com/vi/websocat):

```sh
brew install websocat  # для macOS (через Homebrew)
sudo apt install websocat  # для Ubuntu/Debian
```

Подключитесь к серверу:

```sh
websocat ws://127.0.0.1:8000/ws/workout
```

Затем вручную отправляйте сообщения в формате JSON, например:
```
{"event": "rep_detected", "type": "squat"}
```

#### Windows

Для Windows можно использовать [wscat](https://github.com/websockets/wscat):

Установите Node.js, затем:

```sh
npm install -g wscat
wscat -c ws://127.0.0.1:8000/ws/workout
```

## Как работает debounce

Я использую Redis как замок с таймером. В купе своей атомарностью, это гарантирует не более 1 повторения в секунду. Также с помощью этого подхода можно расширить имплементацию где на каждого юзера применяется отдельный замок.
**Алгоритм:**
1. При получении события "rep_detected" сервис пытается установить ключ-блокировку в Redis (`lock:session:{session_id}`) с флагом NX (только если ключ не существует) и EX=1 (истекает через 1 секунду).
2. Если ключ установлен — повторение засчитывается и увеличивается счётчик.
3. Если ключ уже существует — событие игнорируется (повторение не засчитывается).

## Принцип работы /workout/finish

Этот эндпоинт завершает текущую тренировочную сессию пользователя, сохраняет итоговое количество повторений в базе данных и очищает данные сессии в Redis.

**Алгоритм работы:**
1. Получает идентификатор пользователя и тип упражнения (по умолчанию — "squat").
2. Извлекает из Redis общее количество повторений для текущей сессии.
3. Сохраняет результат тренировки (user_id, exercise_type, total_reps, created_at) в таблицу `workout_sessions` в PostgreSQL.
4. Очищает данные сессии в Redis (счётчик повторений и блокировку).
5. Возвращает ID сохранённой тренировки.

**Пример ответа:**
```json
{
  "status": "success",
  "workout_id": 1
}
```

## Принцип работы /workout/sessions

Этот эндпоинт возвращает список всех сохранённых тренировочных сессий из базы данных PostgreSQL. В ответе содержатся поля: id, user_id, exercise_type, total_reps, created_at.

**Пример ответа:**
```json
[
  {
    "id": 1,
    "user_id": "1",
    "exercise_type": "squat",
    "total_reps": 15,
    "created_at": "2024-06-09T12:34:56"
  },
]
```

## Миграции

Для ручного управления миграциями используйте:
```sh
alembic revision --autogenerate -m "описание"
alembic upgrade head
```
